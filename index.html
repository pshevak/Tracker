<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTE Mission Tracker</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Tailwind Configuration for Custom Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        lavender: {
                            50: '#fcfaff',
                            100: '#f6f0fe',
                            200: '#efe6fd',
                            300: '#dfccfb',
                            400: '#c59bf6',
                            500: '#a76bf0', // Primary Light
                            600: '#934be6',
                            700: '#7e36cd',
                            800: '#682eab', // Primary Dark
                            900: '#56278b',
                        },
                        dark: {
                            bg: '#0f172a', // Slate 900
                            card: '#1e293b', // Slate 800
                        }
                    },
                    animation: {
                        'bounce-short': 'bounce-short 0.3s ease-in-out 1',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        'bounce-short': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #c59bf6;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #7e36cd;
        }

        /* Smooth Theme Transition */
        body, .glass, button, input, textarea, .progress-bar {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-lavender-50 text-slate-800 dark:bg-dark-bg dark:text-lavender-100 flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    <nav class="w-full p-4 flex justify-between items-center glass sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-lavender-500 text-white p-2 rounded-lg shadow-lg dark:bg-lavender-600">
                <i class="fa-solid fa-rocket text-xl"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-lavender-800 dark:text-lavender-300 hidden md:block">FTE Mission Control</h1>
            <h1 class="text-xl font-bold tracking-tight text-lavender-800 dark:text-lavender-300 md:hidden">FTE Tracker</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleGoalPanel()" class="flex items-center gap-2 text-sm font-semibold bg-white/50 dark:bg-slate-700/50 hover:bg-white dark:hover:bg-slate-700 px-4 py-2 rounded-full border border-lavender-200 dark:border-slate-600 transition-all">
                <i class="fa-solid fa-crosshairs text-lavender-600 dark:text-lavender-400"></i>
                <span class="hidden sm:inline">Set Targets</span>
            </button>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-lavender-200 dark:hover:bg-slate-700 transition-all focus:outline-none w-10 h-10 flex items-center justify-center">
                <i class="fa-solid fa-moon text-lavender-700 text-xl dark:hidden"></i>
                <i class="fa-solid fa-sun text-yellow-400 text-xl hidden dark:block"></i>
            </button>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 md:p-8 max-w-5xl">
        
        <!-- Motivational Quote Section -->
        <section id="quoteSection" class="mb-6 p-6 rounded-2xl glass shadow-lg text-center transform hover:scale-[1.01] transition-transform duration-300 border-l-4 border-lavender-500 dark:border-lavender-400">
            <p id="quoteText" class="text-lg md:text-xl font-medium italic text-slate-700 dark:text-lavender-200 mb-2">
                "Code represents the logic of the mind."
            </p>
            <p class="text-sm text-lavender-600 dark:text-lavender-400 font-bold uppercase tracking-wider">- Mission Command</p>
        </section>

        <!-- Goal Settings Panel (Collapsible) -->
        <div id="goalPanel" class="hidden mb-8 glass p-6 rounded-2xl shadow-xl border-2 border-lavender-300 dark:border-lavender-700 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-red-400"></i> Targets for: <span id="goalPanelDate" class="text-lavender-600 dark:text-lavender-400 underline decoration-dotted">Today</span>
                </h3>
                <button onclick="toggleGoalPanel()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Hours Target -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Hours Goal</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="targetHours" step="0.5" class="w-full bg-white/60 dark:bg-slate-800 rounded-lg p-2 border border-lavender-200 dark:border-slate-600 font-bold text-slate-700 dark:text-white" value="4">
                        <span class="text-xs text-slate-400 font-bold">HRS</span>
                    </div>
                </div>
                <!-- Apps Target -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Apps Goal</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="targetApps" class="w-full bg-white/60 dark:bg-slate-800 rounded-lg p-2 border border-lavender-200 dark:border-slate-600 font-bold text-slate-700 dark:text-white" value="5">
                        <span class="text-xs text-slate-400 font-bold">count</span>
                    </div>
                </div>
                <!-- Leetcode Target -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">LeetCode Goal</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="targetLeetcode" class="w-full bg-white/60 dark:bg-slate-800 rounded-lg p-2 border border-lavender-200 dark:border-slate-600 font-bold text-slate-700 dark:text-white" value="2">
                        <span class="text-xs text-slate-400 font-bold">count</span>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="saveGoals()" class="bg-lavender-600 hover:bg-lavender-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all">Save Targets for this Date</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Inputs & Current Stats -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Date Selector for Daily View -->
                <div class="flex justify-between items-center bg-white/40 dark:bg-slate-800/40 p-3 rounded-xl border border-lavender-100 dark:border-slate-700">
                    <label class="text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-day text-lavender-600 dark:text-lavender-400"></i> Viewing Data For:
                    </label>
                    <input type="date" id="viewDate" class="bg-white dark:bg-slate-900 border border-lavender-200 dark:border-slate-600 rounded-lg px-3 py-1 text-slate-700 dark:text-white text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-lavender-400">
                </div>

                <!-- Analytical Dashboard Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- Hours Card -->
                    <div class="glass p-5 rounded-2xl shadow-md relative overflow-hidden group border-t-4 border-blue-400">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-blue-100 dark:bg-slate-700 text-blue-600 dark:text-blue-400 rounded-lg">
                                <i class="fa-solid fa-clock text-lg"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400 dark:text-slate-500 font-bold uppercase">All Time</p>
                                <p id="totalHours" class="text-sm font-bold text-slate-600 dark:text-slate-300">0</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1">Hours Studied</h3>
                        
                        <!-- Progress Section -->
                        <div class="mt-3">
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-blue-500" id="hoursLabel">Today</span>
                                <span class="text-slate-500 dark:text-slate-400"><span id="todayHours">0</span> / <span id="goalHoursDisplay">0</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                <div id="progressHours" class="bg-blue-500 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Applications Card -->
                    <div class="glass p-5 rounded-2xl shadow-md relative overflow-hidden group border-t-4 border-green-400">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-green-100 dark:bg-slate-700 text-green-600 dark:text-green-400 rounded-lg">
                                <i class="fa-solid fa-paper-plane text-lg"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400 dark:text-slate-500 font-bold uppercase">All Time</p>
                                <p id="totalApps" class="text-sm font-bold text-slate-600 dark:text-slate-300">0</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1">Applications</h3>
                        
                        <!-- Progress Section -->
                        <div class="mt-3">
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-green-500" id="appsLabel">Today</span>
                                <span class="text-slate-500 dark:text-slate-400"><span id="todayApps">0</span> / <span id="goalAppsDisplay">0</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                <div id="progressApps" class="bg-green-500 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- LeetCode Card -->
                    <div class="glass p-5 rounded-2xl shadow-md relative overflow-hidden group border-t-4 border-orange-400">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-orange-100 dark:bg-slate-700 text-orange-600 dark:text-orange-400 rounded-lg">
                                <i class="fa-solid fa-code text-lg"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400 dark:text-slate-500 font-bold uppercase">All Time</p>
                                <p id="totalLeetcode" class="text-sm font-bold text-slate-600 dark:text-slate-300">0</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1">LeetCode</h3>
                        
                        <!-- Progress Section -->
                        <div class="mt-3">
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-orange-500" id="leetcodeLabel">Today</span>
                                <span class="text-slate-500 dark:text-slate-400"><span id="todayLeetcode">0</span> / <span id="goalLeetcodeDisplay">0</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                <div id="progressLeetcode" class="bg-orange-500 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mission Analytics Chart -->
                <div class="glass p-6 rounded-3xl shadow-xl border border-lavender-200 dark:border-slate-700">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-lavender-200">
                            <i class="fa-solid fa-chart-simple"></i> Weekly Consistency
                        </h2>
                        <div class="flex bg-lavender-100 dark:bg-slate-800 p-1 rounded-lg">
                            <button onclick="updateChartMetric('hours')" id="btn-chart-hours" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-white bg-lavender-600 shadow-sm">Hours</button>
                            <button onclick="updateChartMetric('apps')" id="btn-chart-apps" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-slate-500 dark:text-slate-400 hover:text-lavender-600">Apps</button>
                            <button onclick="updateChartMetric('leetcode')" id="btn-chart-leetcode" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-slate-500 dark:text-slate-400 hover:text-lavender-600">LeetCode</button>
                        </div>
                    </div>
                    <div class="w-full h-64">
                        <canvas id="missionChart"></canvas>
                    </div>
                </div>

                <!-- Input Zone -->
                <div class="glass rounded-3xl p-6 shadow-xl border border-lavender-200 dark:border-slate-700">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800 dark:text-lavender-200">
                        <i class="fa-solid fa-pen-to-square"></i> Log Activity
                    </h2>
                    
                    <!-- Notes / Feelings Section -->
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Mission Notes / Feelings (Optional)</label>
                        <textarea id="inputNote" rows="2" class="w-full bg-white/50 dark:bg-slate-800/50 rounded-xl border border-lavender-100 dark:border-slate-700 p-3 text-slate-800 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-lavender-400 focus:outline-none transition-all text-sm" placeholder="How was this session? e.g. 'Struggled with DP' or 'Feeling confident!'"></textarea>
                    </div>

                    <div class="space-y-6">
                        <!-- Hours Input -->
                        <div class="flex items-center gap-4 bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl border border-lavender-100 dark:border-slate-700 hover:border-blue-300 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-slate-700 flex items-center justify-center text-blue-500">
                                <i class="fa-solid fa-hourglass-half"></i>
                            </div>
                            <div class="flex-grow">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Study Session (Hours)</label>
                                <input type="number" id="inputHours" placeholder="e.g. 2.5" step="0.5" class="w-full bg-transparent border-none focus:ring-0 text-slate-800 dark:text-white font-semibold text-lg p-0 placeholder-slate-400">
                            </div>
                            <button onclick="addLog('hours')" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:shadow-lg active:scale-95 transition-all">
                                Log
                            </button>
                        </div>

                        <!-- Apps Input -->
                        <div class="flex items-center gap-4 bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl border border-lavender-100 dark:border-slate-700 hover:border-green-300 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-slate-700 flex items-center justify-center text-green-500">
                                <i class="fa-solid fa-briefcase"></i>
                            </div>
                            <div class="flex-grow">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Applications Sent</label>
                                <input type="number" id="inputApps" placeholder="Count" value="1" class="w-full bg-transparent border-none focus:ring-0 text-slate-800 dark:text-white font-semibold text-lg p-0 placeholder-slate-400">
                            </div>
                            <button onclick="addLog('apps')" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:shadow-lg active:scale-95 transition-all">
                                Send
                            </button>
                        </div>

                        <!-- LeetCode Input -->
                        <div class="flex items-center gap-4 bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl border border-lavender-100 dark:border-slate-700 hover:border-orange-300 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-slate-700 flex items-center justify-center text-orange-500">
                                <i class="fa-solid fa-code-branch"></i>
                            </div>
                            <div class="flex-grow">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">LeetCode Solved</label>
                                <input type="number" id="inputLeetcode" placeholder="Count" value="1" class="w-full bg-transparent border-none focus:ring-0 text-slate-800 dark:text-white font-semibold text-lg p-0 placeholder-slate-400">
                            </div>
                            <button onclick="addLog('leetcode')" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-lg font-medium shadow-md hover:shadow-lg active:scale-95 transition-all">
                                Solved
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between items-center pt-4 border-t border-lavender-200 dark:border-slate-700">
                         <button onclick="exportData()" class="flex items-center gap-2 text-xs font-bold text-lavender-600 hover:text-lavender-800 dark:text-lavender-400 dark:hover:text-lavender-200 bg-lavender-100 dark:bg-slate-700 py-2 px-3 rounded-lg transition-colors">
                            <i class="fa-solid fa-file-csv"></i> Export Analytics
                         </button>
                         <button onclick="clearAllData()" class="text-xs text-red-400 hover:text-red-600 dark:hover:text-red-300 underline transition-colors">Reset Mission Data</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: History Log -->
            <div class="lg:col-span-1">
                <div class="glass rounded-3xl shadow-xl h-full max-h-[650px] flex flex-col border border-lavender-200 dark:border-slate-700">
                    <div class="p-5 border-b border-lavender-100 dark:border-slate-700 bg-lavender-50/50 dark:bg-slate-800/50 rounded-t-3xl">
                        <h2 class="text-lg font-bold text-slate-800 dark:text-lavender-200 flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-lavender-500"></i> Mission Log
                        </h2>
                    </div>
                    
                    <div id="historyContainer" class="flex-grow overflow-y-auto p-4 space-y-3">
                        <!-- History Items will be injected here -->
                        <div class="text-center text-slate-400 text-sm mt-10 italic">No mission data recorded yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- State Management ---
        const QUOTES = [
            "Every bug you fix is a step closer to your offer letter.",
            "Consistenty beats intensity. Keep logging.",
            "You don't have to be great to start, but you have to start to be great.",
            "The expert in anything was once a beginner.",
            "Rejection is just redirection to a better opportunity.",
            "1% better every day adds up to 37x better in a year.",
            "Focus on the process, the result will follow.",
            "Your future self will thank you for the LeetCode you do today.",
            "Hard work beats talent when talent doesn't work hard.",
            "Pain is temporary. Quitting lasts forever. Keep coding."
        ];

        let state = {
            totals: { hours: 0, apps: 0, leetcode: 0 },
            logs: [],
            theme: 'light',
            goals: { hours: 4, apps: 5, leetcode: 2 }, // Default/Global goals
            dailyTargets: {} // Stores targets per date string "YYYY-MM-DD"
        };
        
        let missionChart = null;
        let currentChartMetric = 'hours';
        let viewDate = new Date().toISOString().split('T')[0]; // Default to today

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            
            // Set Date Picker to Today
            const dateInput = document.getElementById('viewDate');
            dateInput.value = viewDate;
            dateInput.max = new Date().toISOString().split('T')[0]; // Can't pick future
            dateInput.addEventListener('change', (e) => {
                viewDate = e.target.value;
                updateGoalPanelInputs(); // Update inputs when date changes
                renderUI();
            });

            // Initial input sync
            updateGoalPanelInputs();
            renderUI();
            updateQuote();
            applyTheme(state.theme);
        });

        // --- Core Functions ---

        function loadState() {
            const savedState = localStorage.getItem('fteMissionState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state = { ...state, ...parsed }; 
                if(!state.goals) state.goals = { hours: 4, apps: 5, leetcode: 2 }; 
                if(!state.dailyTargets) state.dailyTargets = {};
            } else {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    state.theme = 'dark';
                }
            }
        }

        function saveState() {
            localStorage.setItem('fteMissionState', JSON.stringify(state));
        }

        // Helper: Get Targets for a specific date (Fallback to global if not set)
        function getTargetsForDate(dateStr) {
            if (state.dailyTargets && state.dailyTargets[dateStr]) {
                return state.dailyTargets[dateStr];
            }
            return state.goals; // Fallback to default/global goals
        }

        function toggleGoalPanel() {
            const panel = document.getElementById('goalPanel');
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                panel.classList.remove('hidden');
                updateGoalPanelInputs(); // Ensure inputs are fresh when opening
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateGoalPanelInputs() {
            const targets = getTargetsForDate(viewDate);
            document.getElementById('targetHours').value = targets.hours;
            document.getElementById('targetApps').value = targets.apps;
            document.getElementById('targetLeetcode').value = targets.leetcode;
            
            // Update visual date indicator in panel
            const dateObj = new Date(viewDate + 'T00:00:00'); // Force local time handling
            const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric'});
            document.getElementById('goalPanelDate').innerText = dateStr;
        }

        function saveGoals() {
            const h = parseFloat(document.getElementById('targetHours').value) || 0;
            const a = parseInt(document.getElementById('targetApps').value) || 0;
            const l = parseInt(document.getElementById('targetLeetcode').value) || 0;

            if (!state.dailyTargets) state.dailyTargets = {};
            
            // Save specifically for the VIEWED date
            state.dailyTargets[viewDate] = { hours: h, apps: a, leetcode: l };
            
            // Also update global default to be the most recent entry (UX choice: assume user wants new standard)
            state.goals = { hours: h, apps: a, leetcode: l };

            saveState();
            renderUI();
            toggleGoalPanel();
            
            confetti({ particleCount: 50, spread: 70, origin: { y: 0.3 }, colors: ['#a76bf0', '#fcfaff'] });
        }

        // Get totals for ANY specific date string (YYYY-MM-DD)
        function getTotalsForDate(dateStr) {
            // Find logs for this specific date
            const daysLogs = state.logs.filter(log => {
                // Convert timestamp to local YYYY-MM-DD
                const logDate = new Date(log.timestamp);
                const localLogDate = logDate.toLocaleDateString('en-CA'); // 'en-CA' outputs YYYY-MM-DD
                return localLogDate === dateStr;
            });

            const totals = { hours: 0, apps: 0, leetcode: 0 };
            
            daysLogs.forEach(log => {
                if (totals[log.type] !== undefined) {
                    totals[log.type] += log.amount;
                }
            });
            
            totals.hours = Math.round(totals.hours * 10) / 10;
            return totals;
        }

        function addLog(type) {
            let amount = 0;
            let inputId = '';
            
            const noteInput = document.getElementById('inputNote');
            const noteValue = noteInput.value.trim();

            if (type === 'hours') {
                inputId = 'inputHours';
                amount = parseFloat(document.getElementById(inputId).value);
            } else if (type === 'apps') {
                inputId = 'inputApps';
                amount = parseInt(document.getElementById(inputId).value);
            } else if (type === 'leetcode') {
                inputId = 'inputLeetcode';
                amount = parseInt(document.getElementById(inputId).value);
            }

            if (!amount || amount <= 0) return;

            // Update Total All Time State
            state.totals[type] = parseFloat((state.totals[type] + amount).toFixed(1));
            
            // Check if we already have a log for this type TODAY
            const todayStr = new Date().toLocaleDateString('en-CA');
            const existingLogIndex = state.logs.findIndex(log => 
                log.type === type && 
                new Date(log.timestamp).toLocaleDateString('en-CA') === todayStr
            );

            if (existingLogIndex !== -1) {
                // Update existing log entry
                const log = state.logs[existingLogIndex];
                log.amount = parseFloat((log.amount + amount).toFixed(1));
                log.timestamp = new Date().toISOString(); // Update timestamp to now
                
                // Append note if new note exists
                if (noteValue) {
                    log.note = log.note ? log.note + " | " + noteValue : noteValue;
                }
                
                // Move to top of list
                state.logs.splice(existingLogIndex, 1);
                state.logs.unshift(log);
            } else {
                // Create New Log
                const newLog = {
                    id: Date.now(),
                    type: type,
                    amount: amount,
                    note: noteValue,
                    timestamp: new Date().toISOString()
                };
                state.logs.unshift(newLog);
            }
            
            saveState();
            renderUI();
            triggerConfetti();
            updateQuote();
            
            noteInput.value = '';
            if (type === 'hours') document.getElementById(inputId).value = '';
            else document.getElementById(inputId).value = '1';
        }

        function renderUI() {
            const isToday = viewDate === new Date().toLocaleDateString('en-CA');
            const todayTotals = getTotalsForDate(viewDate);
            const targets = getTargetsForDate(viewDate);
            
            // Update labels to show if we are looking at history
            const labelText = isToday ? "Today" : "Selected Day";
            document.getElementById('hoursLabel').innerText = labelText;
            document.getElementById('appsLabel').innerText = labelText;
            document.getElementById('leetcodeLabel').innerText = labelText;

            // Helper to update card
            const updateCard = (type, dayVal, totalVal, goalVal, barId, todayId, goalDisplayId, totalId) => {
                document.getElementById(totalId).innerText = totalVal;
                document.getElementById(todayId).innerText = dayVal;
                document.getElementById(goalDisplayId).innerText = goalVal;

                let percent = (dayVal / goalVal) * 100;
                if (goalVal === 0) percent = dayVal > 0 ? 100 : 0;
                if (percent > 100) percent = 100;
                
                const bar = document.getElementById(barId);
                bar.style.width = `${percent}%`;
                
                if (dayVal >= goalVal && goalVal > 0) {
                    bar.classList.remove('bg-blue-500', 'bg-green-500', 'bg-orange-500');
                    bar.classList.add('bg-yellow-400'); 
                } else {
                    bar.classList.remove('bg-yellow-400');
                    if(type === 'hours') bar.classList.add('bg-blue-500');
                    if(type === 'apps') bar.classList.add('bg-green-500');
                    if(type === 'leetcode') bar.classList.add('bg-orange-500');
                }
            };

            updateCard('hours', todayTotals.hours, state.totals.hours, targets.hours, 'progressHours', 'todayHours', 'goalHoursDisplay', 'totalHours');
            updateCard('apps', todayTotals.apps, state.totals.apps, targets.apps, 'progressApps', 'todayApps', 'goalAppsDisplay', 'totalApps');
            updateCard('leetcode', todayTotals.leetcode, state.totals.leetcode, targets.leetcode, 'progressLeetcode', 'todayLeetcode', 'goalLeetcodeDisplay', 'totalLeetcode');

            renderLogs();
            renderChart();
        }

        function renderLogs() {
            const historyContainer = document.getElementById('historyContainer');
            if (state.logs.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-slate-400 text-sm mt-10 italic">No mission data recorded yet.</div>';
                return;
            }

            historyContainer.innerHTML = state.logs.map(log => {
                const date = new Date(log.timestamp);
                const dateStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                
                let icon, colorClass, label;
                if (log.type === 'hours') {
                    icon = 'fa-clock';
                    colorClass = 'text-blue-500 bg-blue-100 dark:bg-blue-900/30';
                    label = 'Hours';
                } else if (log.type === 'apps') {
                    icon = 'fa-paper-plane';
                    colorClass = 'text-green-500 bg-green-100 dark:bg-green-900/30';
                    label = 'Apps';
                } else {
                    icon = 'fa-code';
                    colorClass = 'text-orange-500 bg-orange-100 dark:bg-orange-900/30';
                    label = 'LeetCode';
                }

                const noteHtml = log.note 
                    ? `<div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-600"><p class="text-xs text-slate-600 dark:text-slate-300 italic">"${log.note}"</p></div>` 
                    : '';

                return `
                    <div class="p-3 rounded-xl bg-white/40 dark:bg-slate-700/40 border border-white/50 dark:border-slate-600 animate-fade-in hover:bg-white/60 dark:hover:bg-slate-700/60 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center shrink-0">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-bold text-slate-700 dark:text-slate-200 text-sm">${label}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${dateStr} â€¢ ${timeStr}</p>
                            </div>
                            <div class="font-bold text-lg text-slate-800 dark:text-white">
                                ${log.amount}
                            </div>
                        </div>
                        ${noteHtml}
                    </div>
                `;
            }).join('');
        }
        
        // --- Chart Logic ---
        function updateChartMetric(metric) {
            currentChartMetric = metric;
            
            // Update Buttons
            ['hours', 'apps', 'leetcode'].forEach(m => {
                const btn = document.getElementById(`btn-chart-${m}`);
                if (m === metric) {
                    btn.classList.remove('text-slate-500', 'hover:text-lavender-600', 'bg-transparent');
                    btn.classList.add('text-white', 'bg-lavender-600', 'shadow-sm');
                } else {
                    btn.classList.add('text-slate-500', 'hover:text-lavender-600', 'bg-transparent');
                    btn.classList.remove('text-white', 'bg-lavender-600', 'shadow-sm');
                }
            });
            
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('missionChart').getContext('2d');
            
            // 1. Generate Last 7 Days Labels & Data
            const labels = [];
            const actualData = [];
            const goalData = [];
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('en-CA');
                
                // Label (e.g., "Mon 12")
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
                
                // Get Data for that day
                const totals = getTotalsForDate(dateStr);
                actualData.push(totals[currentChartMetric]);
                
                // Goal (Look up specific daily target)
                const target = getTargetsForDate(dateStr);
                goalData.push(target[currentChartMetric]);
            }

            // Colors based on metric
            let mainColor = '#a76bf0'; // Lavender default
            if (currentChartMetric === 'hours') mainColor = '#3b82f6'; // Blue
            if (currentChartMetric === 'apps') mainColor = '#22c55e'; // Green
            if (currentChartMetric === 'leetcode') mainColor = '#f97316'; // Orange

            if (missionChart) {
                missionChart.destroy();
            }

            // Determine Text Color based on Theme
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#cbd5e1' : '#64748b';

            missionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual',
                            data: actualData,
                            backgroundColor: mainColor,
                            borderRadius: 4,
                            order: 1
                        },
                        {
                            label: 'Target',
                            data: goalData,
                            type: 'line',
                            borderColor: isDark ? '#94a3b8' : '#94a3b8',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 0,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? '#1e293b' : '#ffffff',
                            titleColor: isDark ? '#f1f5f9' : '#0f172a',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? '#334155' : '#e2e8f0',
                                borderDash: [2, 4]
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function exportData() {
            if (state.logs.length === 0) {
                alert("No mission data to export yet! Log some activities first.");
                return;
            }

            // Group data by Date (YYYY-MM-DD key for sorting)
            const groupedData = {};

            // Process logs
            state.logs.forEach(log => {
                const date = new Date(log.timestamp);
                const dateKey = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                const dateDisplay = date.toLocaleDateString(); // Local format
                
                if (!groupedData[dateKey]) {
                    // Look up the specific target for THIS date key
                    const dailyTarget = getTargetsForDate(dateKey);
                    
                    groupedData[dateKey] = {
                        displayDate: dateDisplay,
                        hours: 0,
                        hoursTarget: dailyTarget.hours,
                        apps: 0,
                        appsTarget: dailyTarget.apps,
                        leetcode: 0,
                        leetcodeTarget: dailyTarget.leetcode,
                        notes: new Set()
                    };
                }
                
                const entry = groupedData[dateKey];
                
                if (log.type === 'hours') {
                    entry.hours = log.amount;
                } else if (log.type === 'apps') {
                    entry.apps = log.amount;
                } else if (log.type === 'leetcode') {
                    entry.leetcode = log.amount;
                }
                
                if (log.note) {
                    entry.notes.add(log.note);
                }
            });

            let csvContent = "data:text/csv;charset=utf-8,";
            // Header
            csvContent += "Date,Hours Studied,Hours Goal,Apps Sent,Apps Goal,LeetCode Solved,LeetCode Goal,Daily Notes\n";

            // Sort keys descending (Newest date first)
            const sortedKeys = Object.keys(groupedData).sort().reverse();

            sortedKeys.forEach(key => {
                const data = groupedData[key];
                // Join unique notes. 
                const noteString = Array.from(data.notes).join(" | ").replace(/"/g, '""');
                
                csvContent += `"${data.displayDate}",${data.hours},${data.hoursTarget},${data.apps},${data.appsTarget},${data.leetcode},${data.leetcodeTarget},"${noteString}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "fte_mission_analytics_summary.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearAllData() {
            if(confirm("Are you sure you want to reset all your mission progress? This cannot be undone.")) {
                state.totals = { hours: 0, apps: 0, leetcode: 0 };
                state.logs = [];
                state.dailyTargets = {};
                saveState();
                renderUI();
            }
        }

        function updateQuote() {
            const quoteText = document.getElementById('quoteText');
            const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            quoteText.style.opacity = '0';
            setTimeout(() => {
                quoteText.innerText = `"${randomQuote}"`;
                quoteText.style.opacity = '1';
            }, 300);
        }

        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme(state.theme);
            saveState();
            renderChart(); // Re-render chart to update colors
        });

        function applyTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        }

        function triggerConfetti() {
            const defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(200 * particleRatio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }
    </script>
</body>
</html>
